package com.yokior.milvus;

import com.alibaba.fastjson2.JSONObject;
import com.alibaba.fastjson2.JSONWriter;
import com.google.protobuf.Descriptors;
import com.yokior.common.EmbedSearchResult;
import com.yokior.utils.MilvusUtils;
import io.milvus.grpc.*;
import io.milvus.param.MetricType;
import io.milvus.v2.common.IndexParam;
import io.milvus.v2.service.vector.response.SearchResp;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.*;
import java.util.stream.Collectors;

/**
 * @author Yokior
 * @description
 * @date 2026/1/7 15:05
 */
@SpringBootTest
@Slf4j
public class MilvusServiceTest {

    @Autowired
    private MilvusUtils milvusUtils;

    @Test
    void testSearch() {
        String vectorString = "0.028093573, -0.0076522627, 0.050760515, -0.057704806, -0.053046513, 0.018948242, 0.054383475, -0.034330223, -0.034538638, -0.057221044, -0.029759232, -0.045178063, 0.07613193, -0.026794065, 0.03182682, -0.01283341, -0.047357492, -0.0053849444, -0.06516438, 0.069472775, -0.0024600995, 0.059265006, 0.078059345, -0.042299412, 0.041313265, 0.055340197, 0.005567762, 0.040977202, -0.036796402, 0.08448113, -0.1086368, 0.024172276, 0.02364701, 0.057274856, -0.041741777, 0.02536289, 0.010215349, 0.009190686, -0.018385539, -0.055121936, -0.085067056, 0.010846699, -0.08371748, 0.045431376, 0.046981443, 0.0065138587, -0.06806255, -0.025573371, 0.07091122, 0.009197824, -0.039086137, -0.013571308, -0.06299681, 0.03554312, -0.016391857, 0.037133586, -0.019876037, -0.01252039, -0.0799816, -0.012769847, -0.06568006, 0.013298824, 0.009927008, 0.015111614, 0.052762948, -0.051130474, 0.015376881, -0.036352668, -0.013593359, 0.015752677, -0.016371466, -0.0054929308, 5.597021e-05, -0.0062254104, 0.006853001, 0.007866553, -0.0711024, -0.0031606338, 0.0024510203, 0.045934275, -0.018599676, 0.01843868, -0.063347384, -0.062714756, 0.03437234, -0.04267869, -0.015204782, -0.015965706, 0.01710235, 0.036929857, 0.03790601, 0.040701456, 0.07920718, 0.021428738, 0.040959567, 0.019377857, -0.07683382, -0.026632221, -0.063873805, 0.03589533, 0.09552934, 0.0947974, 0.006775741, 0.0039638444, 0.018112343, -0.0994969, 0.010598908, -0.0031946043, -0.028368883, -5.289523e-05, -0.045859408, 0.03236495, 0.050465424, 0.05700693, 0.007325989, 0.02826609, -0.0024180787, -0.041333925, 0.010027726, -0.030702623, 0.008461855, -0.0090330215, -0.03916006, -0.030679742, 0.014962219, -0.03087928, -0.08883221, -0.020575998, -0.021308525, 0.08381656, -0.044910375, 0.009275747, 0.07875726, -0.044018153, -0.0059963157, -0.080657616, -0.029201232, -0.033012096, 0.038828466, -0.010862958, -0.007037853, 0.025745323, 0.009238634, -0.017742213, -0.024410749, 0.03333006, 0.009160216, -0.02746887, 0.11129401, 0.093602605, 0.03845505, 0.03676564, -0.03751464, -0.04914255, -0.011667499, -0.028403223, -0.0068961056, 0.04023686, 0.083168626, 0.02984531, 0.050174363, 0.0038994798, 0.07798861, -0.07204106, -0.004446348, -0.089683846, 0.029614164, 0.018507019, -0.0063403323, -0.07122538, 0.059432622, -0.024410913, -0.058481183, 0.022955112, 0.043358248, -0.05286405, -0.0049078544, -0.054429047, 0.050729793, 0.008324901, -0.017879052, 0.019889815, -0.030867163, 0.12918532, -0.0060385433, 0.0018705509, 0.009943532, -0.03935432, 0.054910555, -0.008175139, 0.07231258, 0.0075851977, -0.006302068, 0.045083713, 0.013774995, 0.0112968385, 0.026353898, 0.04920931, 0.016361855, -0.009645915, 0.069726564, 0.010328954, 0.08392091, 0.028278261, 0.058976468, 0.030377705, -0.08261681, 0.06597894, -0.00976307, -0.097178705, 0.012109055, 0.009680339, 0.04330178, 0.04555406, -0.0053356974, -0.03701596, 0.05607557, 0.0012407909, 0.030010348, -0.032404825, -0.002770165, -0.09333413, -0.02717477, 0.0047941157, 0.0041737068, -0.053433787, -0.037978236, -0.01064954, 0.003664875, -0.032094155, 0.023999797, -0.108986594, -0.0014604628, -0.051805966, -0.01146721, -0.011102493, -0.022855096, 0.01853185, 0.060093082, -0.01904711, -0.022729203, -0.033023544, -0.034085482, -0.02210026, -0.022716163, -0.029422961, 0.08606085, -0.037192997, 0.00057631516, -0.0491559, 0.0021726007, 0.03915304, -0.04921301, -0.036514252, 0.028259212, -0.0133265825, -0.0067267264, -0.001282785, 0.060448624, 0.09372461, 0.04090332, 0.016162017, -0.02001393, 0.0796731, -0.0064566126, 0.005364102, -0.12939389, -0.032747723, 0.06714729, 0.03444884, -0.005815238, -0.04361165, -0.009767897, 0.07913271, -0.040586002, 0.00911553, -0.03272183, -0.0220025, 0.006794154, -0.012830173, 0.0016588569, 0.07691223, 0.09070721, 0.0336247, -0.009345654, -0.04438626, -0.040553935, 0.08981771, 0.024023414, -0.03529488, 0.024105033, 0.088846534, 0.02209789, 0.035075437, 0.04747074, -0.008256994, -0.021673353, -0.07592371, 0.004145499, 0.012535144, -0.021277713, 0.057877243, 0.025734233, 0.026397208, -0.023158154, -0.0042153187, -0.044782445, 0.029045071, -0.013425791, -0.03790514, -0.057442103, -0.0284883, -0.08605262, -0.0194048, -0.004132135, 0.006788495, 0.009178026, -0.00042037293, -0.008521911, 0.04465896, 0.029177783, -0.0590598, -0.0017534617, 0.07817616, -0.020234536, 0.03141189, -0.005979309, -0.020427864, -0.026102457, 0.05743794, -0.051912617, 0.033024877, -0.073137864, 0.004983207, 0.023396863, -0.031108418, 0.055829447, 0.062178243, 0.104941316, 0.004452271, -0.028262869, -0.0082554575, 0.0067174872, -0.0154555235, 0.022788735, 0.063503444, -0.0023009356, -0.055502243, -0.050617468, 0.044301394, 0.07185331, -0.055670276, -0.026125614, 0.0061487616, 0.041937996, 0.015288116, -0.03609733, 0.062119033, 0.0569425, -0.018095084, 0.013400842, 0.008859689, -0.022308988, 0.02061268, 0.021945108, 0.00015285843, 0.0104182875, 0.052788887, -0.07722492, -0.016400568, 0.009780142, -0.0449859, -0.0069504254, 0.03835731, -0.11501258, 0.033205703, 0.045583367, -0.078016005, 0.057806335, 0.0033860195, 0.016933456, -0.016012765, 0.024265548, -0.054818574, 0.016099567, 0.028266251, 0.047602974, 0.0049156533, 0.024865963, -0.008660993, -0.025267653, 0.0018571112, 0.008918172, -0.042168807, 0.035190146, -0.06601259, -0.016656157, -0.026015662, -0.07213541, -0.00050496485, 0.04696119, -0.070592105, -0.008213377, -0.0061849724, -0.0038429738, 0.035773702, 0.013033489, 0.008533411, 0.03694648, -0.050879788, -0.003580959, -0.017198883, -0.002451292, -0.01055971, 0.03496641, -0.0137757575, -0.0014296866, 0.092879176, 0.0027396332, -0.06297973, -0.01704982, 0.0046526506, -0.017623376, 0.0024557656, -0.08050191, 0.0043594134, 0.043176994, -0.063649364, -0.019714005, -0.0133382995, -0.024405632, -0.0070157927, -0.005199723, -0.037812874, -0.044396035, -0.070662096, -0.0005311074, -0.0064725964, 0.019518038, 0.023745812, 0.049313076, -0.011535343, -0.0030134474, -0.14783308, 0.022103017, 0.023773687, -0.021890538, -0.010525623, -0.030911565, -0.06724502, 0.05639895, -0.036429606, -0.08146583, 0.019841406, 0.02730753, 0.012485582, 0.0041304976, 0.027504511, -0.005970033, -0.016638923, 0.088392116, -0.045682926, -0.054510415, -0.031451344, 0.03447002, -0.033957858, 0.059783258, -0.08176407, -0.085277356, -0.03163937, -0.14954555, 0.0007836273, -0.020888643, 0.021636974, -0.017561972, 0.013508703, -0.018078722, -0.07390905, 0.081064574, 0.0032284723, -0.04191111, -0.04473012, -0.080589615, -0.07898925, 0.060530506, 0.04397416, 0.05001181, -0.093332134, 0.03946744, 0.011116384, -0.050171435, 0.0372825, 0.033114944, -0.031082356, 0.02526898, -0.036594536, 0.052511547, 0.024860967, 0.006055178, -0.016179621, -0.013105009, -0.035631407, 0.030137243, -0.0033891597, -0.0024498273, -0.087334625, 0.05103356, -0.012089227, -0.019419784, 0.028414613, -0.01971964, 0.033764135";

        List<Float> vector = Arrays.stream(vectorString.split(","))
                .map(Float::parseFloat)
                .collect(Collectors.toList());


        // 转换结果
        SearchResp searchResp = milvusUtils.search("JavaProject", List.of(vector), 5, IndexParam.MetricType.COSINE);
        List<EmbedSearchResult> embedSearchResultList = new ArrayList<>();

        for (SearchResp.SearchResult data : searchResp.getSearchResults().get(0)) {
            EmbedSearchResult embedSearchResult = new EmbedSearchResult();
            Map<String, Object> entity = data.getEntity();
            embedSearchResult.setId((Long) data.getId());
            embedSearchResult.setScore(data.getScore());
            embedSearchResult.setContent((String) entity.get("content"));
            embedSearchResult.setType((String) entity.get("type"));
            embedSearchResult.setClassName((String) entity.get("class_name"));
            embedSearchResult.setMethodName((String) entity.get("method_name"));
            embedSearchResult.setSite((String) entity.get("site"));
            embedSearchResult.setProjectName((String) entity.get("project_name"));

            log.info(JSONObject.toJSONString(embedSearchResult, JSONWriter.Feature.PrettyFormat));

            embedSearchResultList.add(embedSearchResult);
        }


    }

    @Test
    void testInsert() {
        String content = "package com.example.controller; @RestController @RequestMapping(\"/api/users\") public class UserController { @GetMapping(\"/{id}\") public ResponseEntity<User> getUser(@PathVariable Long id) { return ResponseEntity.ok(userService.findById(id)); } }";

        String vectorString = "0.0014682729, -0.06568792, 0.04313766, -0.07563297, -0.12141315, 0.02687529, 0.01717417, -0.022320043, 0.06909106, -0.0651026, -0.064475186, -0.08477586, 0.07475939, 0.025589421, 0.026972625, 0.0761771, 0.037887096, -0.025998728, -0.07969765, 0.009630135, 0.09248542, 0.03622466, 0.04734124, 0.016621897, 0.08517925, -0.006178369, 0.042138163, 0.06743219, 0.08495836, 0.07205424, -0.09310236, -0.011305972, -0.06681943, 0.032939617, -0.025721354, 0.0065495498, 0.032986734, -0.0037891776, 0.010829769, -0.010434983, -0.14105183, 0.032604415, 0.039629344, -0.02343421, -0.012874118, 0.077623375, -0.12310669, -0.037669685, 0.06638722, -0.007583023, 0.0075576794, -0.03732148, -0.057020802, 0.0050396645, -0.0143301245, 0.029631956, -0.053158138, 0.04897937, -0.054047126, -0.034801837, -0.0053010527, 0.017939156, -0.04686062, 0.044500627, -0.008512026, 0.012829862, 0.028645752, -0.01234334, -0.01541656, 0.019153943, 0.03543268, -0.024339212, 0.014099296, 0.026948122, 0.10934225, 0.039433975, -0.030154036, 0.01798157, 0.04097723, 0.0504207, 0.014716599, 0.044839848, 0.0047990144, -0.014548014, 0.026453126, -0.019576604, 0.01460329, 0.019939847, 0.028013041, 0.04556992, 0.07720456, 0.019303594, -0.027852427, 0.0006748247, -0.023476535, 0.028376993, -0.05276303, -0.02758122, -0.025073223, -0.046206273, 0.06256499, 0.055173073, -0.009190271, 0.017661415, -0.016352296, -0.04262784, 0.0094384635, 0.013804883, -0.0659414, 0.03056607, -0.06880492, 0.024935367, 0.055706955, -0.008660564, 0.012440908, -0.05273564, -0.05770954, -0.04944675, 0.06342189, 0.0067857807, 0.010858715, -0.0051379623, -0.013286078, -0.000681083, -0.013852328, 0.0041573187, -0.012970205, -0.0037277425, -0.057820767, 0.0717262, -0.030715907, -0.017862188, 0.111967675, -0.03391455, 0.026702167, -0.042336382, -0.015413313, -0.026913147, -0.03634482, -0.074426174, 0.01769945, 0.01623666, -0.03733426, -0.003969486, -0.040782075, 0.027985832, -0.05596213, -0.05196944, 0.02838484, 0.043703556, -0.026980368, 0.04945235, -0.021519804, 0.025420021, 0.03653136, -0.05409683, -0.019930007, -0.04209409, 0.013705197, -0.05602723, -0.01572018, -0.10622676, 0.030479804, -0.043598272, 0.007994455, -0.028067514, 0.0010052166, -0.049352363, -0.033558216, -0.04596908, -0.06221195, -0.013658363, -0.0028075415, 0.003725017, -0.0098345, -0.017376106, 0.0035323605, -0.05255301, 0.066356115, -0.0073563596, -0.029218504, -0.025013965, -0.022931919, 0.03086902, 0.029045874, -0.014511201, -0.011513959, -0.01267817, 0.0048880205, -0.050004713, 0.068565965, -0.021072432, 0.033751536, 0.048371013, 0.044273827, 0.002770638, -0.025977636, 0.06512027, 0.05236116, -0.037420865, 0.045276083, 0.02119236, 0.003538053, -0.011449549, -0.011366048, 0.037422474, 0.058434673, 0.087656714, -0.006625397, 0.0070052417, -0.010474844, -0.008261075, 0.029641626, 0.03332868, -0.036519125, -0.111934915, 0.04732956, -0.007361032, 0.024491474, -0.051796984, -0.05346121, -0.051810984, 0.031895164, 0.0066334894, 0.059448842, -0.0017894395, -0.034384105, -0.0028274048, 0.029501103, -0.044198047, 0.01018211, -0.08121341, 0.019815508, -0.03188354, -0.0070375246, 0.062405877, 0.008819143, -0.07377963, 0.06452091, -0.033209875, 0.00037197766, -0.001264071, 0.019226156, 0.037452724, -0.026326507, 0.009463667, -0.038909603, 0.022746336, -0.06849535, -0.0070096413, -0.058157574, 0.0027665796, -0.03956738, -0.03382657, 0.012901813, 0.03952109, 0.043868925, 0.016294591, 0.05750554, 0.03439266, -0.00028038493, -0.030311927, -0.028556753, 0.053569827, -0.0048714066, 0.016390618, -0.029114773, -0.03158117, 0.022969568, 0.02428133, -0.005360431, -0.020450415, 0.020993857, 0.029501785, -0.08553615, -0.063355274, -0.018154724, -0.012438572, -0.048683047, -0.027380422, -0.039506122, 0.028388109, 0.08012787, -0.009816501, -0.049868017, -0.012276883, -0.0316812, 0.04202223, 0.027668847, -0.0068222466, -0.02084921, 0.1421475, -0.001591639, 0.043596536, 0.012285984, 0.07209002, 0.009377586, 0.051733654, 0.008813273, 0.009092765, -0.05184047, 0.008291205, -0.051561538, -0.035325665, 0.023217116, -0.026651906, -0.022845699, 0.030237252, 0.049906563, 0.02714034, -0.02021975, -0.039329406, -0.030817669, -0.050397255, 0.017773032, 0.021564227, -0.009953956, 0.058140744, -0.07891527, 0.03702069, 0.0442412, -0.015710667, 0.0025815626, 0.060329467, 0.009319664, 0.062296722, 0.04080883, -0.020206735, -0.041081246, -0.0069580534, -0.063135974, 0.018641815, -0.042150863, 0.024205668, -0.00090955786, -0.033054702, 0.0078109307, 0.020740412, 0.061628416, 0.022664044, -0.082455926, -0.08514725, 0.010559565, -0.003961398, 0.003700918, 0.012979828, 0.041977037, -0.06274614, -0.052402582, 0.004528478, 0.04386143, -0.027919965, -0.06668479, -0.0136401635, 0.04164983, 0.02926414, 0.008717821, -0.02155753, -0.016909216, 0.044389624, -0.014768589, 0.00090184, -0.027512759, -0.025320532, -0.0008332292, -0.045917463, 0.024390768, 0.034427296, -0.06486769, 0.036342036, 0.04832654, 0.03160378, -0.0008698478, 0.061095838, -0.16851674, -0.042794283, 0.1258858, -0.12540029, 0.0417285, -0.011688809, -0.0059861247, -0.058179397, 0.00556246, -0.028513953, 0.005744074, 0.053287048, 0.01724135, -0.009176847, 0.02649776, -0.034585003, -0.070147395, -0.005153015, -0.010987977, 0.016644726, -0.03579468, -0.0142660085, -0.0019903148, 0.009584745, -0.10224047, 0.016991787, 0.07329134, -0.052653752, -0.05217959, -0.08869715, 0.022705171, -0.052191734, 0.0009222825, 0.051135097, -0.02216679, -0.04772631, -0.035612695, -0.005373779, 0.0051826444, -0.009283377, 0.08191208, -0.05950566, -0.03509693, 0.067507744, -0.030582676, -0.03408521, 0.044767197, 0.0135351615, -0.017807938, 0.03801517, -0.041106932, 0.015886756, 0.07088887, 0.013701509, -0.060572226, 0.02303453, 0.011080197, -0.011503123, -0.094300106, -0.016279083, -0.0069292914, -0.04824657, 0.013368213, -0.07107875, 0.043519985, 0.004294687, 0.06838722, -0.043497846, 0.010713342, -0.09437828, 0.035425622, 0.03551983, -0.009178472, -0.01119174, 0.00092800305, -0.06607301, -0.022030296, -0.041697852, -0.05378429, 0.045789685, 0.015419369, -0.032913204, -0.014653484, -0.027772233, 0.0014301816, 0.02805006, 0.041274555, -0.0399104, -0.06020575, -0.023800422, 0.09577654, -0.04338427, -0.017829858, -0.032257624, -0.041610926, 0.028861895, -0.05296757, -0.027082585, -0.051364087, -0.01403383, -0.033538725, 0.01196084, -0.018466493, -0.12881334, 0.04210182, -0.024586748, -0.027591215, -0.055112995, -0.057394885, -0.0996225, -0.029361423, 0.034972645, 0.001034231, -0.028032461, 0.003595231, 0.020417426, 0.022984557, 0.036027964, 0.08781324, 0.02246119, 0.08414366, -0.06262382, 0.01189774, -0.043294147, 0.0019687754, -0.0040998417, 0.0018943283, -0.013412188, 0.04935332, -0.02590986, -0.00455366, -0.10464636, 0.041229542, -0.063364476, 0.019390272, 0.040611662, -0.057861105, 0.045212902";

        // 转换成列表
        List<Float> vector = Arrays.stream(vectorString.split(","))
                .map(Float::parseFloat)
                .collect(Collectors.toList());

        String type = "method";
        String site = "src/test/java/com/yokior/milvus/MilvusServiceTest.java";
        String projectName = "测试Java项目";
        String className = "MilvusServiceTest";
        String methodName = "testInsert";

        boolean b = milvusUtils.insert("TestJava", List.of(vector), List.of(content), List.of(type), List.of(site), projectName, List.of(className), List.of(methodName));
        log.info("插入结果：{}", b);
    }
}
